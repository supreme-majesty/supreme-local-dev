# JSON Log Format for X-Ray
log_format sld_xray_json escape=json '{'
    '"time_iso": "$time_iso8601", '
    '"msec": "$msec", '
    '"remote_addr": "$remote_addr", '
    '"method": "$request_method", '
    '"host": "$host", '
    '"uri": "$request_uri", '
    '"status": $status, '
    '"body_bytes": $body_bytes_sent, '
    '"latency": "$request_time", '
    '"upstream_latency": "$upstream_response_time", '
    '"agent": "$http_user_agent"'
'}';

server {
    listen 80;
    server_name *.test;
    root {{SLD_RUNTIME_PATH}};

    # Output to X-Ray log
    access_log /var/log/nginx/sld-xray.log sld_xray_json;
    # Keep standard error log
    error_log /var/log/nginx/sld-error.log;

    # Dynamic dispatch to router.php
    location / {
        try_files /router.php =404;
        fastcgi_pass unix:/run/php/php-fpm.sock; # Default Ubuntu socket usually
        fastcgi_index router.php;
        fastcgi_param SCRIPT_FILENAME $document_root/router.php;
        include fastcgi_params;
        fastcgi_param HTTP_HOST $host;
        fastcgi_param PHP_VALUE "error_reporting=E_ALL & ~E_DEPRECATED";
        
        # Buffer settings for large headers (Laravel encrypted sessions)
        fastcgi_buffers 16 32k;
        fastcgi_buffer_size 64k;
        fastcgi_busy_buffers_size 64k;
    }

    # Nginx Status Page for Dashboard Metrics
    location /sld-nginx-status {
        stub_status;
        allow 127.0.0.1;
        deny all;
        access_log off;
    }
}

server {
    listen 80;
    server_name sld.test;
    location /api {
        proxy_pass http://127.0.0.1:2025;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location / {
        proxy_pass http://127.0.0.1:2025;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

