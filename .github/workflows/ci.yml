name: Validation

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_call:

jobs:
  validate-daemon:
    name: Validate Daemon (Go)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          check-latest: true

      - name: Go Format Check
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Run gofmt on the following files:"
            gofmt -l .
            exit 1
          fi

      - name: Go Vet
        run: go vet ./...

      - name: Go Test
        run: go test -v ./...

      # Security Scan (Go)
      - name: Run Trivy vulnerability scanner (Repo)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          ignore-unfixed: true
          format: "table"
          severity: "CRITICAL,HIGH"

  validate-ui:
    name: Validate UI (React/Tauri)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: sld-dashboard
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: sld-dashboard/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      # If there's a type-check script (tsk), run it. Assuming standard vite setup often has `tsc -b` in build `build`.
      - name: Type Check
        run: npx tsc --noEmit
